<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luffy Smart App</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            transition: background-color 0.5s;
        }
        .card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
            border-top: 6px solid #d32f2f;
            position: relative;
        }
        
        /* Estado de Alerta */
        body.feeding-time { background-color: #e8f5e9; }
        body.feeding-time .card { border-top-color: #2e7d32; box-shadow: 0 0 30px rgba(76, 175, 80, 0.4); }

        h1 { color: #333; margin: 0; font-size: 1.8rem; letter-spacing: -0.5px; }
        h4 { color: #666; font-weight: normal; margin-top: 5px; margin-bottom: 20px; font-size: 0.9rem; }
        
        .info-row {
            display: flex; justify-content: space-between; margin-bottom: 10px;
            font-size: 0.95rem; color: #555; background: #f8f9fa;
            padding: 12px; border-radius: 10px; border: 1px solid #eee;
        }

        .select-container { margin: 20px 0; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #444; font-size: 0.9rem; }
        select {
            width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd;
            font-size: 1rem; background-color: white; outline: none;
        }

        .result-box {
            background-color: #e3f2fd; color: #0d47a1; padding: 20px;
            border-radius: 15px; box-shadow: inset 0 0 10px rgba(0,0,0,0.02);
            transition: background-color 0.5s, color 0.5s;
        }
        body.feeding-time .result-box { background-color: #c8e6c9; color: #1b5e20; }
        
        .big-number { font-size: 3.5rem; font-weight: 800; color: #d32f2f; line-height: 1; margin: 10px 0; }
        body.feeding-time .big-number { color: #2e7d32; }

        .meal-box {
            margin-top: 15px; font-size: 1.1rem; font-weight: bold;
            background: rgba(255,255,255,0.7); padding: 12px;
            border-radius: 8px; border: 1px solid rgba(0,0,0,0.1);
        }

        .status-bar {
            margin-top: 20px; padding: 15px; background: #333; color: white;
            border-radius: 10px; font-size: 1rem; font-weight: bold;
        }
        body.feeding-time .status-bar { background: #2e7d32; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .dynamic-schedule {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 10px;
        }
        .time-input-group { display: flex; flex-direction: column; align-items: center; }
        .time-label { font-size: 0.75rem; color: #888; margin-bottom: 4px; text-transform: uppercase; }
        input[type="time"] {
            font-family: 'Segoe UI', sans-serif; font-size: 1.1rem; padding: 5px;
            border: 1px solid #ddd; border-radius: 8px; background: white; color: #333;
            width: 100%; text-align: center; cursor: pointer; font-weight: bold;
        }
        input[type="time"]:focus { border-color: #d32f2f; outline: none; background: #fffafa; }
        input[type="time"].past { color: #aaa; background: #f4f4f4; }
        input[type="time"].next { border: 2px solid #2e7d32; color: #2e7d32; }

        .sync-indicator {
            font-size: 0.7rem; color: #999; margin-top: 10px; font-style: italic;
        }

        .footer { margin-top: 25px; font-size: 0.75rem; color: #aaa; line-height: 1.4; }
    </style>
</head>
<body>

    <div class="card">
        <h1>Luffy Family ‚òÅÔ∏è</h1>
        <h4>Royal Canin Giant Puppy (Meta 75kg)</h4>

        <div class="info-row">
            <span>Idade:</span>
            <strong id="idadeDisplay">--</strong>
        </div>

        <div class="select-container">
            <label for="refeicoesSelect">Rotina de hoje:</label>
            <select id="refeicoesSelect" onchange="resetarHorarios(true)">
                <option value="4" selected>4 Refei√ß√µes (Ideal)</option>
                <option value="3">3 Refei√ß√µes (Dias corridos)</option>
            </select>
        </div>

        <div class="result-box">
            <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Total Di√°rio</div>
            <div id="totalGrams" class="big-number">-- g</div>
            
            <div class="meal-box">
                <span id="numRefeicoesDisplay">4</span> potes de <span id="perMeal" style="font-size: 1.3em;">--</span> g
            </div>
        </div>

        <div id="statusBar" class="status-bar">Conectando...</div>

        <div id="clockContainer" class="dynamic-schedule"></div>
        <div id="syncStatus" class="sync-indicator">Sincronizando com a fam√≠lia...</div>

        <div class="footer">
            Os hor√°rios s√£o compartilhados com todos.<br>
            Altera√ß√µes salvam automaticamente na nuvem.
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const DATA_NASCIMENTO = new Date(2025, 9, 31); // 31/10/2025
        
        // ******************************************************
        // COLOQUE SEU PANTRY ID DENTRO DAS ASPAS ABAIXO:
        const PANTRY_ID = "c42cdca2-f5c9-4b78-b7ba-527236418398"; 
        // ******************************************************

        const BASKET_NAME = "LuffySchedule";
        const API_URL = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`;

        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            calcularDieta(); 
            carregarDaNuvem(); // Primeira carga
            
            // Loop de Verifica√ß√£o (Sincroniza e checa status a cada 30s)
            setInterval(() => {
                carregarDaNuvem(); 
                verificarStatus();
            }, 30000);

            // Rel√≥gio local r√°pido para a interface n√£o parecer travada
            setInterval(verificarStatus, 60000); 
        };

        // --- SISTEMA DE NUVEM (PANTRY) ---
        function salvarNaNuvem() {
            const inputs = document.querySelectorAll('input[type="time"]');
            const horarios = Array.from(inputs).map(i => i.value);
            const numRefeicoes = document.getElementById('refeicoesSelect').value;
            const hoje = new Date().toLocaleDateString(); 

            const dados = {
                data: hoje,
                modo: numRefeicoes,
                times: horarios,
                autor: "AppUser"
            };
            
            document.getElementById('syncStatus').innerText = "Salvando na nuvem...";
            
            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            })
            .then(() => {
                document.getElementById('syncStatus').innerText = "‚úÖ Salvo e Sincronizado!";
                setTimeout(() => { document.getElementById('syncStatus').innerText = ""; }, 3000);
            })
            .catch(err => {
                console.error(err);
                document.getElementById('syncStatus').innerText = "‚ùå Erro ao salvar (sem internet?)";
            });
        }

        function carregarDaNuvem() {
            fetch(API_URL)
            .then(response => response.json())
            .then(dados => {
                const hoje = new Date().toLocaleDateString();
                
                // Se os dados da nuvem forem de hoje, usamos eles
                if (dados.data === hoje) {
                    aplicarDados(dados);
                } else {
                    // Se os dados s√£o velhos, n√£o faz nada (mant√©m padr√£o ou reseta se for o primeiro load)
                    // O reset acontece se n√£o tivermos inputs ainda
                    if(document.getElementById('clockContainer').innerHTML === "") {
                        resetarHorarios(false); 
                    }
                }
            })
            .catch(() => {
                // Se der erro (ex: primeira vez que usa e a gaveta t√° vazia), inicia padr√£o
                if(document.getElementById('clockContainer').innerHTML === "") {
                    resetarHorarios(false);
                }
            });
        }

        function aplicarDados(dados) {
            // Evita reconstruir se nada mudou (para n√£o tirar o foco do usu√°rio)
            const currentMode = document.getElementById('refeicoesSelect').value;
            
            if (currentMode !== dados.modo) {
                document.getElementById('refeicoesSelect').value = dados.modo;
                gerarInputsVisuais(parseInt(dados.modo));
                calcularDieta(); // Recalcula gramas
            } else if (document.getElementById('clockContainer').innerHTML === "") {
                 gerarInputsVisuais(parseInt(dados.modo));
            }

            const inputs = document.querySelectorAll('input[type="time"]');
            let mudouAlgo = false;
            
            dados.times.forEach((time, index) => {
                if (inputs[index] && inputs[index].value !== time) {
                    // S√≥ atualiza se o valor for diferente (para n√£o atrapalhar edi√ß√£o)
                    // E se o elemento n√£o estiver focado
                    if (document.activeElement !== inputs[index]) {
                         inputs[index].value = time;
                         mudouAlgo = true;
                    }
                }
            });
            
            if (mudouAlgo) verificarStatus();
        }

        // --- L√ìGICA DE HOR√ÅRIOS ---
        function gerarInputsVisuais(numRefeicoes) {
            const container = document.getElementById('clockContainer');
            container.innerHTML = "";
            let intervalo = (numRefeicoes === 4) ? 4 : 6;

            for (let i = 0; i < numRefeicoes; i++) {
                let div = document.createElement('div');
                div.className = 'time-input-group';
                
                let label = document.createElement('span');
                label.className = 'time-label';
                label.innerText = `Refei√ß√£o ${i+1}`;
                
                let input = document.createElement('input');
                input.type = 'time';
                input.id = `time-${i}`;
                
                input.onchange = function() { 
                    recalcularCascata(i, numRefeicoes, intervalo);
                    salvarNaNuvem(); // Agora salva na nuvem!
                };

                div.appendChild(label);
                div.appendChild(input);
                container.appendChild(div);
            }
        }

        function resetarHorarios(isManualChange) {
            const numRefeicoes = parseInt(document.getElementById('refeicoesSelect').value);
            gerarInputsVisuais(numRefeicoes);

            let horaBase = 7; 
            let intervalo = (numRefeicoes === 4) ? 4 : 6;
            const inputs = document.querySelectorAll('input[type="time"]');

            inputs.forEach((input, i) => {
                let h = horaBase + (i * intervalo);
                if (h >= 24) h -= 24;
                input.value = `${h.toString().padStart(2, '0')}:00`;
            });

            calcularDieta();
            verificarStatus();
            if (isManualChange) salvarNaNuvem();
        }

        function recalcularCascata(indexMudado, totalRefeicoes, intervalo) {
            let inputMudado = document.getElementById(`time-${indexMudado}`);
            if(!inputMudado.value) return;

            let [h, m] = inputMudado.value.split(':').map(Number);
            let minutosBase = (h * 60) + m;

            for (let i = indexMudado + 1; i < totalRefeicoes; i++) {
                let inputProximo = document.getElementById(`time-${i}`);
                minutosBase += (intervalo * 60);
                
                let novosMinutos = minutosBase % 1440;
                let novaHora = Math.floor(novosMinutos / 60);
                let novoMin = novosMinutos % 60;

                inputProximo.value = `${novaHora.toString().padStart(2, '0')}:${novoMin.toString().padStart(2, '0')}`;
            }
            verificarStatus();
        }

        function verificarStatus() {
            const agora = new Date();
            const minutosAgora = (agora.getHours() * 60) + agora.getMinutes();
            const inputs = document.querySelectorAll('input[type="time"]');
            
            let proximaRefeicao = null;
            let alimentarAgora = false;

            inputs.forEach(input => {
                if (!input.value) return;
                let [h, m] = input.value.split(':').map(Number);
                let minutosRef = (h * 60) + m;

                input.classList.remove('past', 'next');

                if (minutosAgora >= (minutosRef - 15) && minutosAgora <= (minutosRef + 45)) {
                    alimentarAgora = true;
                    input.classList.add('next');
                } else if (minutosAgora > minutosRef + 45) {
                    input.classList.add('past');
                } else if (proximaRefeicao === null) {
                    proximaRefeicao = input.value;
                    input.classList.add('next');
                }
            });

            const statusDiv = document.getElementById('statusBar');
            if (alimentarAgora) {
                document.body.classList.add('feeding-time');
                statusDiv.innerText = `üçñ HORA DE COMER!`;
            } else {
                document.body.classList.remove('feeding-time');
                statusDiv.innerText = proximaRefeicao ? `‚è≥ Pr√≥xima: ${proximaRefeicao}` : `‚úÖ Tudo pronto por hoje!`;
            }
        }

        // --- C√ÅLCULO DE RA√á√ÉO ---
        function calcularDieta() {
            const hoje = new Date();
            hoje.setHours(0,0,0,0); 

            let meses = (hoje.getFullYear() - DATA_NASCIMENTO.getFullYear()) * 12;
            meses -= DATA_NASCIMENTO.getMonth();
            meses += hoje.getMonth();
            let diasExtras = hoje.getDate() - DATA_NASCIMENTO.getDate();
            
            if (diasExtras < 0) {
                meses--;
                let ultimoDiaMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth(), 0).getDate();
                diasExtras += ultimoDiaMesAnterior;
            }
            document.getElementById('idadeDisplay').innerText = `${meses} meses e ${diasExtras} dias`;

            const tabela = { 2: 442, 3: 584, 4: 695, 5: 808, 6: 920, 7: 930, 8: 900 };
            let totalDiario = 0;

            if (meses < 2) totalDiario = 350 + (diasExtras * 3); 
            else if (meses >= 8) totalDiario = 900;
            else {
                const baseAtual = tabela[meses];
                const baseProxima = tabela[meses + 1] || baseAtual;
                totalDiario = baseAtual + ((baseProxima - baseAtual) / 30 * diasExtras);
            }

            const numRefeicoes = parseInt(document.getElementById('refeicoesSelect').value);
            const totalFinal = Math.round(totalDiario);
            const porRefeicao = Math.round(totalFinal / numRefeicoes);

            document.getElementById('totalGrams').innerText = totalFinal + " g";
            document.getElementById('perMeal').innerText = porRefeicao;
            document.getElementById('numRefeicoesDisplay').innerText = numRefeicoes;
        }
    </script>

</body>
</html>
